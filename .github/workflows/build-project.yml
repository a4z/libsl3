name: build project
on:
  push:
    branches:
        - modernize/everything
#         - main

env:
  CONAN_USER_HOME: "${{ github.workspace }}/.conan/"
  CONAN_USER_HOME_SHORT: "${{ github.workspace }}/.conan/short"

jobs:
  build:
    strategy:
      matrix:
        os: [macos-12, ubuntu-22.04]
    runs-on: ${{ matrix.os }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Install Conan
      id: conan
      uses: turtlebrowser/get-conan@main
      with:
        version: 1.57.0
    - name: Cache Conan Home
      id: cache-primes
      uses: actions/cache@v3
      with:
        path: ${{ github.workspace }}/.conan/
        key: ${{ matrix.os }}-${{ matrix.build }}-conan-home
    - name: Create conan default profile
      run: conan profile new default --detect --force
    # not needed in this context, but later
    # - name: Enable conan revisions
    #   run: conan config set general.revisions_enabled=1
    - name: Adopt conan profiles on Ubuntu
      if:  ${{ startsWith(matrix.os,'ubuntu') }}
      run: conan profile update settings.compiler.libcxx=libstdc++11 default
    - uses: seanmiddleditch/gha-setup-ninja@master
    - name: Configure project
      run:  cmake --preset default --compile-no-warning-as-error # TODO , once all is foxed, remove
    - name: Build project
      run:  cmake --build --preset default-release
    - name: Run unit test
      run:  ctest --preset default-release

    # It's enough to cache packages
    - name: Clean up Conan
      run: |
        conan remove -f "*" --builds
        conan remove -f "*" --src
        conan remove -f "*" --system-reqs

